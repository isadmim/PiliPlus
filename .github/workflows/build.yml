name: Build For My Phone

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release Tag (optional)"
        required: false
        default: ""
        type: string

jobs:
  android:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ä»£ç è¿å‡º
        uses: actions/checkout@v4  # ä½¿ç”¨v4ï¼Œæ›´ç¨³å®š
        with:
          fetch-depth: 1  # ä¸éœ€è¦å®Œæ•´å†å²ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: ç¼“å­˜Gradleå’ŒPub
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.pub-cache
          key: ${{ runner.os }}-gradle-pub-${{ hashFiles('**/pubspec.lock', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-pub-

      - name: å®‰è£…Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"  # æ”¹ä¸ºTemurinï¼Œæ€§èƒ½æ›´å¥½
          java-version: "17"
          cache: gradle

      - name: å®‰è£…Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          cache-paths: |
            $FLUTTER_HOME/.pub-cache
            $FLUTTER_HOME/bin/cache

- name: ä»…ä¸ºæ‚¨æ‰‹æœºç”Ÿæˆç­¾åé…ç½®
  run: |
    # åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
    echo "storeFile=upload-keystore.jks" > android/key.properties
    echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
    echo "keyAlias=upload" >> android/key.properties
    echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
    
    # åˆ›å»ºgradle.propertiesä¸­çš„ç­¾åå˜é‡ï¼ˆç”¨äºbuild.gradle.ktsè¯»å–ï¼‰
    echo "" >> android/gradle.properties
    echo "# è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åé…ç½®" >> android/gradle.properties
    echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/gradle.properties
    echo "keyAlias=upload" >> android/gradle.properties
    echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/gradle.properties
    
    # å¤åˆ¶å¯†é’¥æ–‡ä»¶
    echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
    
    echo "âœ… ç­¾åé…ç½®å·²ç”Ÿæˆ"

      - name: è·å–åº”ç”¨ç‰ˆæœ¬
        id: version
        run: |
          # å¿«é€Ÿè·å–ç‰ˆæœ¬å·ï¼Œä¸ä½¿ç”¨PowerShellè„šæœ¬
          VERSION=$(grep -m1 "version:" pubspec.yaml | cut -d' ' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: ä»…æ„å»ºarm64-v8aæ¶æ„
        run: |
          # åªæ„å»ºæ‚¨æ‰‹æœºéœ€è¦çš„æ¶æ„ï¼ˆé€šå¸¸æ˜¯arm64-v8aï¼‰
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            --dart-define-from-file=pili_release.json \
            --split-debug-info=build/symbols/ \
            --obfuscate \
            --no-tree-shake-icons \
            --shrink

      - name: é‡å‘½åAPK
        run: |
          mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
             PiliPlus_${{ steps.version.outputs.version }}_my_phone.apk
          
          echo "âœ… APKæ„å»ºå®Œæˆï¼šPiliPlus_${{ steps.version.outputs.version }}_my_phone.apk"
          echo "ğŸ“± æ–‡ä»¶å¤§å°ï¼š$(du -h PiliPlus_${{ steps.version.outputs.version }}_my_phone.apk | cut -f1)"

      - name: ä¸Šä¼ å•ä¸ªArtifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Android-My-Phone
          path: PiliPlus_*.apk
          retention-days: 30  # åªä¿ç•™30å¤©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

      - name: åˆ›å»ºGitHub Release
        if: ${{ github.event.inputs.tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ç‰ˆæœ¬ ${{ steps.version.outputs.version }}
          files: PiliPlus_*.apk
          generate_release_notes: true